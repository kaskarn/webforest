---
title: "webforest: Interactive Forest Plots for R"
subtitle: "Package Design and Features Guide"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    theme: cosmo
    code_folding: none
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(webforest)
library(dplyr)
```

## Overview

**webforest** is an R htmlwidgets package for creating interactive, web-native forest plots. While traditionally used for meta-analysis, the package supports any data with point estimates and confidence intervals.

### Key Features

- **Modern web rendering** using Svelte 5 and D3.js
- **Multiple preset themes** (JAMA, Lancet, presentation, dark mode)
- **Flexible column system** with special renderers (bars, p-values, sparklines)
- **Hierarchical grouping** with collapsible sections
- **Interactive features** (hover tooltips, row selection, sorting)
- **Fluent API** for theme customization

## Architecture

### The WebSpec Object

At the core of webforest is the `WebSpec` S7 class - a complete specification that gets serialized to JSON and rendered by the JavaScript frontend.

```{r eval=FALSE}
# WebSpec contains:
# - data: rows, groups, summaries, scale settings
# - columns: column definitions for the table
# - theme: visual styling (colors, typography, spacing)
# - interaction: enabled features (sort, filter, collapse)
# - annotations: reference lines, custom markers
```

### Data Flow

```
R Data Frame
     ↓
web_spec() → WebSpec object
     ↓
forest_plot() / webtable()
     ↓
serialize_spec() → JSON
     ↓
Svelte/D3 rendering → HTML widget
```

## Quick Start

### Basic Usage

```{r}
# Sample meta-analysis data
meta_data <- data.frame(
  study = c("Smith 2020", "Jones 2021", "Lee 2022", "Chen 2023", "Park 2024"),
  hr = c(0.72, 0.85, 0.91, 0.68, 0.79),
  lower = c(0.55, 0.70, 0.75, 0.52, 0.61),
  upper = c(0.95, 1.03, 1.10, 0.89, 1.02),
  n = c(245, 180, 320, 156, 210),
  events = c(42, 38, 55, 28, 45)
)

forest_plot(meta_data,
  point = "hr",
  lower = "lower",
  upper = "upper",
  label = "study",
  null_value = 1,
  scale = "log",
  axis_label = "Hazard Ratio (95% CI)"
)
```

### Two-Step Workflow

For more control, create a `WebSpec` first:

```{r}
spec <- web_spec(meta_data,
  point = "hr",
  lower = "lower",
  upper = "upper",
  label = "study",
  null_value = 1,
  scale = "log",
  columns = list(
    col_numeric("n", header = "N", width = 60),
    col_numeric("events", header = "Events", width = 70)
  )
)

# Inspect the spec
spec
```

```{r}
# Then render
forest_plot(spec, axis_label = "Hazard Ratio")
```

## Theme System

### Preset Themes

webforest includes several publication-ready themes:

```{r fig.height=3}
# JAMA style - black & white, dense
forest_plot(meta_data, point = "hr", lower = "lower", upper = "upper",
  label = "study", null_value = 1, scale = "log",
  theme = web_theme_jama())
```

```{r fig.height=3}
# Lancet style - blue palette, serif fonts
forest_plot(meta_data, point = "hr", lower = "lower", upper = "upper",
  label = "study", null_value = 1, scale = "log",
  theme = web_theme_lancet())
```

```{r fig.height=3}
# Modern - clean UI style
forest_plot(meta_data, point = "hr", lower = "lower", upper = "upper",
  label = "study", null_value = 1, scale = "log",
  theme = web_theme_modern())
```

```{r fig.height=3}
# Presentation - large fonts, bold colors
forest_plot(meta_data, point = "hr", lower = "lower", upper = "upper",
  label = "study", null_value = 1, scale = "log",
  theme = web_theme_presentation())
```

### Fluent Theme Customization

Modify themes using pipe-friendly `set_*` functions:

```{r}
custom_theme <- web_theme_jama() |>
  set_colors(
    primary = "#0066cc",
    interval_line = "#0066cc"
  ) |>
  set_spacing(
    row_height = 24
  ) |>
  set_axis(
    gridlines = TRUE,
    gridline_style = "dotted"
  )

forest_plot(meta_data, point = "hr", lower = "lower", upper = "upper",
  label = "study", null_value = 1, scale = "log",
  theme = custom_theme)
```

### Theme Components

| Component | Function | Properties |
|-----------|----------|------------|
| Colors | `set_colors()` | background, foreground, primary, secondary, interval_positive, interval_negative, etc. |
| Typography | `set_typography()` | font_family, font_size_sm/base/lg, font_weight_normal/medium/bold |
| Spacing | `set_spacing()` | row_height, header_height, column_gap, padding |
| Shapes | `set_shapes()` | point_size, summary_height, line_width, border_radius |
| Axis | `set_axis()` | range_min, range_max, tick_count, tick_values, gridlines |
| Layout | `set_layout()` | plot_position, cell_padding_x/y, row_border, container_border |

## Column Types

### Available Column Types

```{r}
# Create data with various column types
demo_data <- data.frame(
  study = c("Alpha", "Beta", "Gamma", "Delta"),
  or = c(1.2, 0.8, 1.5, 0.95),
  lower = c(0.9, 0.5, 1.1, 0.7),
  upper = c(1.6, 1.3, 2.0, 1.3),
  n = c(500, 320, 180, 420),
  weight = c(28, 22, 15, 35),
  pval = c(0.042, 0.23, 0.008, 0.61)
)

forest_plot(demo_data,
  point = "or", lower = "lower", upper = "upper",
  label = "study", null_value = 1,
  columns = list(
    col_numeric("n", header = "N", width = 60),
    col_bar("weight", header = "Weight %", width = 80),
    col_pvalue("pval", header = "P-value", width = 80),
    col_interval(header = "OR (95% CI)", width = 120, position = "right")
  ),
  theme = web_theme_modern()
)
```

### Column Type Reference

| Type | Function | Use Case |
|------|----------|----------|
| `col_text()` | Text values | Study names, categories |
| `col_numeric()` | Formatted numbers | Sample sizes, counts |
| `col_interval()` | Point (CI) format | Effect size display |
| `col_bar()` | Horizontal bar | Weights, percentages |
| `col_pvalue()` | P-value formatting | Significance stars |
| `col_sparkline()` | Mini line/bar chart | Trends, distributions |

### Column Groups

Group related columns under a shared header:

```{r}
forest_plot(demo_data,
  point = "or", lower = "lower", upper = "upper",
  label = "study", null_value = 1,
  columns = list(
    col_group("Statistics",
      col_numeric("n", header = "N"),
      col_bar("weight", header = "Weight")
    ),
    col_pvalue("pval", header = "P", position = "right")
  )
)
```

## Grouping and Hierarchy

### Simple Groups

```{r}
grouped_data <- data.frame(
  study = c("Study A1", "Study A2", "Study B1", "Study B2", "Study B3"),
  region = c("North", "North", "South", "South", "South"),
  or = c(0.8, 0.9, 1.1, 1.3, 0.95),
  lower = c(0.6, 0.7, 0.85, 1.0, 0.7),
  upper = c(1.1, 1.15, 1.4, 1.7, 1.3)
)

forest_plot(grouped_data,
  point = "or", lower = "lower", upper = "upper",
  label = "study",
  group = "region",
  null_value = 1
)
```

### Multiple Group Columns

You can create hierarchical grouping by combining multiple categorical columns:

```{r}
nested_data <- data.frame(
  study = paste("Study", 1:6),
  or = c(0.75, 0.82, 1.1, 1.25, 0.9, 0.95),
  lower = c(0.5, 0.6, 0.85, 0.95, 0.65, 0.7),
  upper = c(1.1, 1.1, 1.4, 1.6, 1.2, 1.3),
  subtype = c("Subtype A", "Subtype A", "Subtype B", "Subtype B", "Subtype A", "Subtype B"),
  region = c("US", "US", "US", "EU", "EU", "EU")
)

# Group by region
forest_plot(nested_data,
  point = "or", lower = "lower", upper = "upper",
  label = "study", null_value = 1,
  group = "region",
  columns = list(
    col_text("subtype", header = "Subtype", width = 80)
  )
)
```

## Axis Control

### Range and Ticks

```{r fig.height=3}
# Auto range (default)
forest_plot(meta_data, point = "hr", lower = "lower", upper = "upper",
  label = "study", null_value = 1, scale = "log",
  theme = web_theme_minimal())
```

```{r fig.height=3}
# Explicit range with gridlines
forest_plot(meta_data, point = "hr", lower = "lower", upper = "upper",
  label = "study", null_value = 1, scale = "log",
  axis_range = c(0.3, 2.0),
  axis_gridlines = TRUE,
  theme = web_theme_minimal())
```

### Custom Tick Values

```{r}
forest_plot(meta_data, point = "hr", lower = "lower", upper = "upper",
  label = "study", null_value = 1, scale = "log",
  axis_ticks = c(0.5, 0.7, 1.0, 1.5, 2.0),
  axis_gridlines = TRUE,
  theme = web_theme_modern())
```

## Interactive Features

### Enabled by Default

- **Hover**: Highlights row across table and plot
- **Click**: Selects row (shows left accent bar)
- **Collapse**: Click group headers to collapse/expand

### Interaction Configuration

```{r eval=FALSE}
# Control which features are enabled
spec <- web_spec(data, ...,
  interaction = web_interaction(
    enable_hover = TRUE,
    enable_select = TRUE,
    enable_collapse = TRUE,
    enable_sort = FALSE,
    show_legend = FALSE
  )
)
```

## Labels and Annotations

### Plot Labels

```{r}
spec <- web_spec(meta_data,
  point = "hr", lower = "lower", upper = "upper",
  label = "study", null_value = 1, scale = "log",
  title = "Treatment Effect on Primary Outcome",
  subtitle = "Randomized controlled trials, 2020-2024",
  caption = "HR < 1 favors treatment",
  footnote = "Data from systematic review"
)

forest_plot(spec)
```

### Reference Lines

```{r}
spec <- web_spec(meta_data,
  point = "hr", lower = "lower", upper = "upper",
  label = "study", null_value = 1, scale = "log",
  annotations = list(
    forest_refline(0.8, label = "Threshold", style = "dashed", color = "#e11d48")
  )
)

forest_plot(spec)
```

## API Reference

### Main Functions

| Function | Purpose |
|----------|---------|
| `web_spec()` | Create a WebSpec from data |
| `forest_plot()` | Render forest plot widget |
| `webtable()` | Render table-only widget |

### Theme Functions

| Function | Purpose |
|----------|---------|
| `web_theme_default()` | Default clean theme |
| `web_theme_jama()` | JAMA journal style |
| `web_theme_lancet()` | Lancet journal style |
| `web_theme_modern()` | Contemporary UI style |
| `web_theme_presentation()` | Large fonts for slides |
| `web_theme_dark()` | Dark mode |
| `web_theme_minimal()` | Minimal black & white |

### Theme Modifiers

| Function | Modifies |
|----------|----------|
| `set_colors()` | Color palette |
| `set_typography()` | Fonts and sizes |
| `set_spacing()` | Row heights, gaps |
| `set_shapes()` | Point sizes, line widths |
| `set_axis()` | Axis range, ticks, gridlines |
| `set_layout()` | Plot position, borders |

### Column Functions

| Function | Creates |
|----------|---------|
| `col_text()` | Text column |
| `col_numeric()` | Number column |
| `col_interval()` | CI formatted column |
| `col_bar()` | Bar chart column |
| `col_pvalue()` | P-value column |
| `col_sparkline()` | Sparkline column |
| `col_group()` | Column group header |

## Session Info

```{r}
sessionInfo()
```
