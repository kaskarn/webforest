---
title: "forest_plot()"
---

```{r}
#| include: false
library(webforest)
library(dplyr)
```

Create interactive forest plots from data frames. This is the primary function for building forest plots in webforest—pass your data directly with column mappings and styling options.

## Quick Example

```{r}
data <- data.frame(
  study = c("Smith 2020", "Jones 2021", "Lee 2022", "Chen 2023"),
  hr = c(0.72, 0.85, 0.91, 0.68),
  lower = c(0.55, 0.70, 0.75, 0.52),
  upper = c(0.95, 1.03, 1.10, 0.89)
)

forest_plot(data,
  point = "hr",
  lower = "lower",
  upper = "upper",
  label = "study",
  null_value = 1,
  scale = "log"
)
```

## Usage

```r
forest_plot(
  x,
  point = NULL,
  lower = NULL,
  upper = NULL,
  label = NULL,
  group = NULL,
  columns = NULL,
  scale = NULL,
  null_value = NULL,
  axis_label = NULL,
  theme = NULL,
  title = NULL,
  subtitle = NULL,
  caption = NULL,
  footnote = NULL,

  # Row styling

  row_type = NULL,
  row_bold = NULL,
  row_italic = NULL,
  row_color = NULL,
  row_bg = NULL,
  row_indent = NULL,
  row_emphasis = NULL,
  row_muted = NULL,
  row_accent = NULL,

  # Marker styling
  marker_color = NULL,
  marker_shape = NULL,
  marker_opacity = NULL,
  marker_size = NULL,

  # Split plots
  split_by = NULL,
  shared_axis = FALSE,

  # Visual overrides
  axis_range = NULL,
  axis_ticks = NULL,
  axis_gridlines = NULL,
  plot_position = NULL,
  row_height = NULL,

  # Zoom & sizing
  zoom = 1.0,
  auto_fit = TRUE,
  max_width = NULL,
  max_height = NULL,
  show_zoom_controls = TRUE,
  width = NULL,
  height = NULL,
  elementId = NULL,

  ...
)
```

---

## Core Arguments

These are the essential arguments for creating any forest plot.

| Argument | Description |
|----------|-------------|
| `x` | A data frame (or `WebSpec` object for advanced use) |
| `point` | Column name for point estimates (required) |
| `lower` | Column name for lower confidence bounds (required) |
| `upper` | Column name for upper confidence bounds (required) |
| `label` | Column name for row labels |

::: {.callout-important}
## The Three Required Mappings

Every forest plot needs at minimum: `point`, `lower`, and `upper`. These define what values to plot.

```r
forest_plot(data, point = "hr", lower = "ci_low", upper = "ci_high")
```
:::

### Scale and Reference

| Argument | Description |
|----------|-------------|
| `scale` | `"linear"` or `"log"` |
| `null_value` | Reference line value (e.g., 1 for ratios, 0 for differences) |
| `axis_label` | X-axis label text |

::: {.callout-tip}
## Scale Selection

- **Log scale** (`scale = "log"`, `null_value = 1`): For ratios where effects are multiplicative (OR, HR, RR)
- **Linear scale** (`scale = "linear"`, `null_value = 0`): For differences where effects are additive (MD, RD, SMD)
:::

### Grouping

| Argument | Description |
|----------|-------------|
| `group` | Column name(s) for grouping rows into collapsible sections |

```r
# Single-level grouping
forest_plot(data, ..., group = "category")

# Hierarchical grouping (region > country)
forest_plot(data, ..., group = c("region", "country"))
```

### Columns

| Argument | Description |
|----------|-------------|
| `columns` | List of column specifications using `col_*()` functions |

```{r}
#| eval: false
forest_plot(data, ...,
  columns = list(
    col_n("n"),
    col_events("events", "n"),
    col_interval("HR (95% CI)"),
    col_pvalue("pval")
  )
)
```

See [Columns Reference](columns.qmd) for all available column types.

### Labels and Titles

| Argument | Description |
|----------|-------------|
| `title` | Plot title |
| `subtitle` | Subtitle below title |
| `caption` | Caption text |
| `footnote` | Footnote at bottom |

---

## Row Styling Arguments

Style entire rows based on column values. Each argument accepts **either a column name (string) or a formula expression (`~ ...`)**.

| Argument | Value Type | Effect |
|----------|------------|--------|
| `row_type` | string | Controls row behavior: `"header"`, `"data"`, `"summary"`, `"spacer"` |
| `row_bold` | logical | Bold text |
| `row_italic` | logical | Italic text |
| `row_color` | string | Text color (CSS color, e.g., `"#1a365d"`) |
| `row_bg` | string | Background color |
| `row_indent` | integer | Indentation level (0, 1, 2, ...) |

### Formula Expressions

Row styling arguments accept formula expressions for conditional styling without pre-computing columns:

```{r}
#| eval: false
forest_plot(data, ...,
  row_bold = ~ pval < 0.05,
  row_color = ~ ifelse(hr < 1, "#16a34a", "#dc2626")
)
```

### Semantic Styling Shortcuts

These apply theme-aware styling that adapts when you change themes:

| Argument | Effect |
|----------|--------|
| `row_emphasis` | Bold text with theme primary color (for key results) |
| `row_muted` | Lighter color, reduced prominence (for secondary data) |
| `row_accent` | Theme accent color (for highlighted findings) |

```{r}
styled_data <- data.frame(
  label = c("Primary Endpoint", "  CV Death", "  MI", "Summary"),
  hr = c(NA, 0.82, 0.79, 0.78),
  lower = c(NA, 0.72, 0.68, 0.65),
  upper = c(NA, 0.94, 0.92, 0.93),
  rtype = c("header", "data", "data", "summary"),
  rbold = c(TRUE, FALSE, FALSE, TRUE),
  rindent = c(0, 1, 1, 0)
)

forest_plot(styled_data,
  point = "hr", lower = "lower", upper = "upper", label = "label",
  row_type = "rtype",
  row_bold = "rbold",
  row_indent = "rindent",
  null_value = 1, scale = "log"
)
```

::: {.callout-warning}
## Row Types and NA Values

Rows with `row_type = "header"` or `"spacer"` should have `NA` for point, lower, and upper. The plot displays them as label-only rows without interval markers.
:::

---

## Marker Styling Arguments

Control the appearance of interval markers (points and lines). Each argument accepts **either a column name (string) or a formula expression (`~ ...`)**.

| Argument | Value Type | Effect |
|----------|------------|--------|
| `marker_color` | string | CSS color for marker fill |
| `marker_shape` | string | Shape: `"square"`, `"circle"`, `"diamond"`, `"triangle"` |
| `marker_opacity` | numeric | Transparency (0–1) |
| `marker_size` | numeric | Size multiplier (1 = default, 2 = double) |

### Using Formula Expressions

```{r}
#| eval: false
forest_plot(data, ...,
  marker_shape = ~ ifelse(design == "RCT", "circle", "square"),
  marker_color = ~ ifelse(pval < 0.05, "#16a34a", "#94a3b8"),
  marker_opacity = ~ ifelse(pval < 0.01, 1, 0.7)
)
```

### Using Column Names

```{r}
direction_data <- data.frame(
  study = c("Trial A", "Trial B", "Trial C", "Trial D"),
  hr = c(0.72, 0.95, 0.68, 1.15),
  lower = c(0.55, 0.78, 0.52, 0.90),
  upper = c(0.94, 1.15, 0.89, 1.47)
) |>
  mutate(
    marker_color = case_when(
      upper < 1 ~ "#16a34a",
      lower > 1 ~ "#dc2626",
      TRUE ~ "#64748b"
    )
  )

forest_plot(direction_data,
  point = "hr", lower = "lower", upper = "upper", label = "study",
  marker_color = "marker_color",
  null_value = 1, scale = "log"
)
```

---

## Fluent API: set_*() Functions

Every styling argument has an equivalent `set_*()` function for pipe-based workflows. Both approaches produce identical results.

```{r}
#| eval: false
# Constructor arguments (all at once)
forest_plot(data,
  point = "hr", lower = "lower", upper = "upper", label = "study",
  row_bold = "is_summary",
  marker_color = "effect_color",
  scale = "log", null_value = 1
)

# Fluent API (step by step)
forest_plot(data,
  point = "hr", lower = "lower", upper = "upper", label = "study",
  scale = "log", null_value = 1
) |>
  set_row_style(bold = "is_summary") |>
  set_marker_style(color = "effect_color")
```

The fluent API is useful when:

- Styling depends on computed columns
- You're creating multiple variants from one base
- You want to apply conditional styling
- You're building reusable styling pipelines

See [Styling Functions](styling.qmd) for complete documentation.

---

## Theme Arguments

| Argument | Description |
|----------|-------------|
| `theme` | A `WebTheme` object or theme name string |

**Theme names**: `"default"`, `"jama"`, `"lancet"`, `"nature"`, `"cochrane"`, `"modern"`, `"presentation"`, `"dark"`, `"minimal"`

```{r}
#| layout-ncol: 2
#| fig-height: 3
small_data <- data.frame(
  study = c("Trial A", "Trial B", "Trial C"),
  hr = c(0.72, 0.85, 0.68),
  lower = c(0.55, 0.70, 0.52),
  upper = c(0.95, 1.03, 0.89)
)

forest_plot(small_data,
  point = "hr", lower = "lower", upper = "upper", label = "study",
  null_value = 1, scale = "log",
  theme = web_theme_jama(), title = "JAMA"
)

forest_plot(small_data,
  point = "hr", lower = "lower", upper = "upper", label = "study",
  null_value = 1, scale = "log",
  theme = web_theme_lancet(), title = "Lancet"
)
```

See [Themes Reference](themes.qmd) for customization options.

---

## Split Plot Arguments

Create multiple linked plots for subgroup analyses.

| Argument | Description |
|----------|-------------|
| `split_by` | Column name(s) to split data into separate plots with sidebar navigation |
| `shared_axis` | `TRUE` to use same axis range across all split plots |

```{r}
#| eval: false
forest_plot(data,
  point = "hr", lower = "lower", upper = "upper", label = "study",
  split_by = "region",
  shared_axis = TRUE,
  scale = "log", null_value = 1
)
```

---

## Visual Override Arguments

Quick adjustments that override theme settings:

| Argument | Description |
|----------|-------------|
| `axis_range` | `c(min, max)` to override axis limits |
| `axis_ticks` | Numeric vector of explicit tick positions |
| `axis_gridlines` | `TRUE`/`FALSE` to show/hide gridlines |
| `plot_position` | `"left"` or `"right"` |
| `row_height` | Row height in pixels |

::: {.callout-tip}
## Equivalence with Theme Modifiers

Direct arguments are shortcuts for theme modifications:

```r
# These are equivalent:
forest_plot(data, ..., row_height = 32)
forest_plot(data, ...) |> set_spacing(row_height = 32)
```
:::

---

## Zoom & Sizing Arguments

| Argument | Description |
|----------|-------------|
| `zoom` | Initial zoom level (0.5 to 2.0, default 1.0) |
| `auto_fit` | Shrink to fit container if too large (default TRUE) |
| `max_width` | Maximum container width in pixels (NULL for none) |
| `max_height` | Maximum container height in pixels (NULL for none) |
| `show_zoom_controls` | Show zoom controls on hover (default TRUE) |
| `width` | Explicit widget width |
| `height` | Explicit widget height |
| `elementId` | HTML element ID for the widget |

---

## Return Value

Returns an `htmlwidget` object that can be:

- Displayed in RStudio Viewer
- Rendered in R Markdown / Quarto documents
- Used in Shiny applications
- Saved to files with `save_plot()`
- Further modified with `set_*()` functions

---

## Complete Examples

### Clinical Trial Summary

```{r}
trial_data <- data.frame(
  study = c("EMPA-REG", "CANVAS", "DECLARE", "DAPA-HF", "EMPEROR"),
  hr = c(0.62, 0.86, 0.93, 0.74, 0.75),
  lower = c(0.49, 0.75, 0.84, 0.65, 0.65),
  upper = c(0.77, 0.97, 1.03, 0.85, 0.86),
  n = c(7020, 10142, 17160, 4744, 3730),
  events = c(490, 585, 1216, 386, 361),
  pval = c(0.0001, 0.02, 0.17, 0.0001, 0.0001)
)

forest_plot(trial_data,
  point = "hr", lower = "lower", upper = "upper", label = "study",
  columns = list(
    col_n("n"),
    col_numeric("events", "Events"),
    col_interval("HR (95% CI)"),
    col_pvalue("pval")
  ),
  null_value = 1, scale = "log",
  theme = web_theme_modern(),
  title = "SGLT2 Inhibitor Cardiovascular Outcomes"
)
```

### Styled Subgroup Analysis

```{r}
subgroup_data <- tibble(
  label = c(
    "Overall Population", "",
    "Age",
    "  < 65 years", "  >= 65 years", "",
    "Sex",
    "  Male", "  Female", "",
    "Diabetes",
    "  Yes", "  No"
  ),
  hr = c(0.78, NA, NA, 0.72, 0.85, NA, NA, 0.76, 0.82, NA, NA, 0.74, 0.81),
  lower = c(0.68, NA, NA, 0.58, 0.72, NA, NA, 0.64, 0.68, NA, NA, 0.61, 0.66),
  upper = c(0.89, NA, NA, 0.89, 1.00, NA, NA, 0.90, 0.99, NA, NA, 0.90, 0.99),
  rtype = c("summary", "spacer", "header", "data", "data", "spacer",
            "header", "data", "data", "spacer", "header", "data", "data"),
  rbold = c(TRUE, FALSE, TRUE, FALSE, FALSE, FALSE,
            TRUE, FALSE, FALSE, FALSE, TRUE, FALSE, FALSE)
)

forest_plot(subgroup_data,
  point = "hr", lower = "lower", upper = "upper", label = "label",
  row_type = "rtype",
  row_bold = "rbold",
  columns = list(col_interval("HR (95% CI)")),
  null_value = 1, scale = "log",
  axis_label = "Hazard Ratio",
  theme = web_theme_jama()
)
```

---

## See Also

- [Styling Functions](styling.qmd) — `set_row_style()`, `set_marker_style()`, and more
- [Themes](themes.qmd) — Preset and custom themes
- [Columns](columns.qmd) — Column type specifications
- [Quick Start Guide](../guide/quick-start.qmd) — Getting started tutorial
- [Customizing Plots](../guide/fluent-api.qmd) — Fluent API patterns
- [Advanced: web_spec()](web_spec.qmd) — Programmatic specification building
