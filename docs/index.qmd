---
title: "webforest"
subtitle: "Interactive Forest Plots for R"
---

```{r}
#| include: false
library(webforest)
```

## Overview

**webforest** is an R htmlwidgets package for creating interactive, web-native forest plots. While traditionally used for meta-analysis, the package supports any data with point estimates and confidence intervals.

### Key Features

- **Modern web rendering** using Svelte 5 and D3.js
- **Multiple preset themes** (JAMA, Lancet, presentation, dark mode)
- **Flexible column system** with special renderers (bars, p-values, sparklines)
- **Hierarchical grouping** with collapsible sections
- **Interactive features** (hover tooltips, row selection, sorting)
- **Fluent API** for theme customization

## Installation

```r
# install.packages("pak")
pak::pak("kaskarn/webforest")
```

## Quick Start

```{r}
# Sample meta-analysis data
meta_data <- data.frame(
  study = c("Smith 2020", "Jones 2021", "Lee 2022", "Chen 2023", "Park 2024"),
  hr = c(0.72, 0.85, 0.91, 0.68, 0.79),
  lower = c(0.55, 0.70, 0.75, 0.52, 0.61),
  upper = c(0.95, 1.03, 1.10, 0.89, 1.02),
  n = c(245, 180, 320, 156, 210),
  events = c(42, 38, 55, 28, 45)
)

forest_plot(meta_data,
  point = "hr",
  lower = "lower",
  upper = "upper",
  label = "study",
  null_value = 1,
  scale = "log",
  axis_label = "Hazard Ratio (95% CI)"
)
```

### Two-Step Workflow

For more control, create a `WebSpec` first:

```{r}
spec <- web_spec(meta_data,
  point = "hr",
  lower = "lower",
  upper = "upper",
  label = "study",
  null_value = 1,
  scale = "log",
  columns = list(
    col_numeric("n", header = "N", width = 60),
    col_numeric("events", header = "Events", width = 70)
  )
)

forest_plot(spec, axis_label = "Hazard Ratio")
```

## Theme System

### Preset Themes

::: {.panel-tabset}

#### JAMA
```{r}
forest_plot(meta_data, point = "hr", lower = "lower", upper = "upper",
  label = "study", null_value = 1, scale = "log",
  theme = web_theme_jama())
```

#### Lancet
```{r}
forest_plot(meta_data, point = "hr", lower = "lower", upper = "upper",
  label = "study", null_value = 1, scale = "log",
  theme = web_theme_lancet())
```

#### Modern
```{r}
forest_plot(meta_data, point = "hr", lower = "lower", upper = "upper",
  label = "study", null_value = 1, scale = "log",
  theme = web_theme_modern())
```

#### Presentation
```{r}
forest_plot(meta_data, point = "hr", lower = "lower", upper = "upper",
  label = "study", null_value = 1, scale = "log",
  theme = web_theme_presentation())
```

#### Dark
```{r}
forest_plot(meta_data, point = "hr", lower = "lower", upper = "upper",
  label = "study", null_value = 1, scale = "log",
  theme = web_theme_dark())
```

:::

### Fluent Theme Customization

Modify themes using pipe-friendly `set_*` functions:

```{r}
custom_theme <- web_theme_jama() |>
  set_colors(primary = "#0066cc", interval_line = "#0066cc") |>
  set_spacing(row_height = 24) |>
  set_axis(gridlines = TRUE, gridline_style = "dotted")

forest_plot(meta_data, point = "hr", lower = "lower", upper = "upper",
  label = "study", null_value = 1, scale = "log",
  theme = custom_theme)
```

### Theme Components

| Component | Function | Properties |
|-----------|----------|------------|
| Colors | `set_colors()` | background, foreground, primary, secondary, interval_positive/negative |
| Typography | `set_typography()` | font_family, font_size_sm/base/lg, font_weight_* |
| Spacing | `set_spacing()` | row_height, header_height, column_gap, padding |
| Shapes | `set_shapes()` | point_size, summary_height, line_width, border_radius |
| Axis | `set_axis()` | range_min/max, tick_count, tick_values, gridlines |
| Layout | `set_layout()` | plot_position, cell_padding_x/y, row_border |

## Column Types

```{r}
demo_data <- data.frame(
  study = c("Alpha", "Beta", "Gamma", "Delta"),
  or = c(1.2, 0.8, 1.5, 0.95),
  lower = c(0.9, 0.5, 1.1, 0.7),
  upper = c(1.6, 1.3, 2.0, 1.3),
  n = c(500, 320, 180, 420),
  weight = c(28, 22, 15, 35),
  pval = c(0.042, 0.23, 0.008, 0.61)
)

forest_plot(demo_data,
  point = "or", lower = "lower", upper = "upper",
  label = "study", null_value = 1,
  columns = list(
    col_numeric("n", header = "N", width = 60),
    col_bar("weight", header = "Weight %", width = 80),
    col_pvalue("pval", header = "P-value", width = 80),
    col_interval(header = "OR (95% CI)", width = 120, position = "right")
  ),
  theme = web_theme_modern()
)
```

| Type | Function | Use Case |
|------|----------|----------|
| `col_text()` | Text values | Study names, categories |
| `col_numeric()` | Formatted numbers | Sample sizes, counts |
| `col_interval()` | Point (CI) format | Effect size display |
| `col_bar()` | Horizontal bar | Weights, percentages |
| `col_pvalue()` | P-value formatting | Significance stars |
| `col_sparkline()` | Mini chart | Trends, distributions |
| `col_group()` | Group header | Organize related columns |

## Grouping

```{r}
grouped_data <- data.frame(
  study = c("Study A1", "Study A2", "Study B1", "Study B2", "Study B3"),
  region = c("North", "North", "South", "South", "South"),
  or = c(0.8, 0.9, 1.1, 1.3, 0.95),
  lower = c(0.6, 0.7, 0.85, 1.0, 0.7),
  upper = c(1.1, 1.15, 1.4, 1.7, 1.3)
)

forest_plot(grouped_data,
  point = "or", lower = "lower", upper = "upper",
  label = "study", group = "region", null_value = 1
)
```

## Axis Control

```{r}
forest_plot(meta_data, point = "hr", lower = "lower", upper = "upper",
  label = "study", null_value = 1, scale = "log",
  axis_range = c(0.3, 2.0),
  axis_ticks = c(0.5, 0.7, 1.0, 1.5, 2.0),
  axis_gridlines = TRUE,
  theme = web_theme_modern())
```

## Labels and Annotations

```{r}
spec <- web_spec(meta_data,
  point = "hr", lower = "lower", upper = "upper",
  label = "study", null_value = 1, scale = "log",
  title = "Treatment Effect on Primary Outcome",
  subtitle = "Randomized controlled trials, 2020-2024",
  caption = "HR < 1 favors treatment",
  annotations = list(
    forest_refline(0.8, label = "Threshold", style = "dashed", color = "#e11d48")
  )
)

forest_plot(spec)
```
