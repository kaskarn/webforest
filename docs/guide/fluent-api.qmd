---
title: "Customizing Plots"
---

```{r}
#| include: false
library(webforest)
library(dplyr)
```

webforest provides a **fluent API** that lets you build and customize plots step by step using R's pipe operator (`|>`).

::: {.callout-tip}
## The Fluent Pattern
The fluent API follows a simple rule: **every function returns a modified object that can be piped into the next function**.

```r
data |>
  web_spec(point = "hr", ...) |>      # Create spec
  set_row_style(bold = "is_key") |>   # Modify rows
  set_marker_style(color = "dir") |>  # Modify markers
  forest_plot(theme = "jama")          # Render
```

Each step modifies and passes forward the same object type (WebSpec or htmlwidget).
:::

## Two Equivalent Approaches

webforest offers two ways to achieve the same result:

### Constructor Arguments (All at Once)

```{r}
#| eval: false
forest_plot(data,
  point = "hr", lower = "lower", upper = "upper", label = "study",
  row_type = "rtype",
  row_bold = "rbold",
  marker_color = "effect_color",
  theme = web_theme_jama(),
  scale = "log", null_value = 1
)
```

### Fluent API (Step by Step)

```{r}
#| eval: false
web_spec(data,
  point = "hr", lower = "lower", upper = "upper", label = "study",
  scale = "log", null_value = 1
) |>
  set_row_style(type = "rtype", bold = "rbold") |>
  set_marker_style(color = "effect_color") |>
  forest_plot(theme = web_theme_jama())
```

Both produce identical output.

::: {.callout-note}
## When to Use Which

| Approach | Best When |
|----------|-----------|
| **Constructor** | Everything is known upfront |
| **Fluent API** | Styling depends on computation |
| **Fluent API** | Creating multiple variants from one base |
| **Fluent API** | Conditional logic determines styling |
| **Fluent API** | Building reusable pipelines |
:::

## Core Modifier Functions

### set_row_style()

Style entire rows based on column values:

```r
spec |> set_row_style(
  type = "rtype",     # "header", "data", "summary", "spacer"
  bold = "rbold",     # Column with TRUE/FALSE
  italic = "ritalic", # Column with TRUE/FALSE
  color = "rcolor",   # Column with hex colors
  bg = "rbg",         # Column with background colors
  badge = "rbadge",   # Column with badge text
  icon = "ricon",     # Column with emoji/unicode
  indent = "rindent"  # Column with indent levels (0, 1, 2, ...)
)
```

**Example**:

```{r}
styled_data <- data.frame(
  study = c("Primary", "  CV Death", "  MI", "Secondary", "  Stroke"),
  hr = c(NA, 0.82, 0.79, NA, 0.88),
  lower = c(NA, 0.72, 0.68, NA, 0.74),
  upper = c(NA, 0.94, 0.92, NA, 1.05),
  rtype = c("header", "data", "data", "header", "data"),
  rbold = c(TRUE, FALSE, FALSE, TRUE, FALSE),
  rindent = c(0, 1, 1, 0, 1)
)

web_spec(styled_data,
  point = "hr", lower = "lower", upper = "upper", label = "study",
  scale = "log", null_value = 1
) |>
  set_row_style(type = "rtype", bold = "rbold", indent = "rindent") |>
  forest_plot(theme = web_theme_modern())
```

### set_marker_style()

Style interval markers based on column values:

```r
spec |> set_marker_style(
  color = "marker_color",   # Column with hex colors
  shape = "marker_shape",   # Column with "square", "circle", "diamond", "triangle"
  opacity = "marker_alpha", # Column with 0-1 values
  size = "marker_size"      # Column with size multipliers
)
```

**Example**:

```{r}
marker_data <- data.frame(
  study = c("Trial A", "Trial B", "Trial C", "Trial D"),
  hr = c(0.72, 0.95, 0.68, 1.15),
  lower = c(0.55, 0.78, 0.52, 0.90),
  upper = c(0.94, 1.15, 0.89, 1.47),
  direction = c("benefit", "neutral", "benefit", "harm")
) |>
  mutate(
    marker_color = case_when(
      upper < 1 ~ "#16a34a",  # Green for benefit
      lower > 1 ~ "#dc2626",  # Red for harm
      TRUE ~ "#64748b"        # Gray for neutral
    ),
    marker_shape = ifelse(direction == "benefit", "circle", "square")
  )

web_spec(marker_data,
  point = "hr", lower = "lower", upper = "upper", label = "study",
  scale = "log", null_value = 1
) |>
  set_marker_style(color = "marker_color", shape = "marker_shape") |>
  forest_plot(theme = web_theme_modern())
```

### set_column_style()

Style individual column cells:

```r
spec |> set_column_style(column = "hr",
  bold = "is_sig",
  color = "hr_color",
  bg = "hr_bg"
)
```

::: {.callout-tip}
## Styling Priority

When both row and column styles are set:

1. Column styles take precedence
2. Row styles apply to all cells without column overrides

This lets you set row-wide defaults with column-specific overrides.
:::

### set_theme() and Theme Modifiers

Apply or modify themes:

```r
# Apply by name
spec |> set_theme("jama")

# Apply by object
spec |> set_theme(web_theme_lancet())

# Modify theme properties inline
spec |> set_colors(primary = "#1a365d")
spec |> set_spacing(row_height = 24)
spec |> set_axis(gridlines = TRUE)
```

All theme modifiers work on both WebSpec and htmlwidget objects.

## Creating Variants

A common pattern is creating multiple versions from one base:

```{r}
base_spec <- web_spec(marker_data,
  point = "hr", lower = "lower", upper = "upper", label = "study",
  scale = "log", null_value = 1
)

# Variant 1: Color by significance
plot_colored <- base_spec |>
  set_marker_style(color = "marker_color") |>
  forest_plot(theme = "modern", title = "Colored by Direction")

# Variant 2: Shape by design
plot_shaped <- base_spec |>
  set_marker_style(shape = "marker_shape") |>
  forest_plot(theme = "modern", title = "Shaped by Design")

# Show one
plot_colored
```

::: {.callout-note}
## Immutable Specs
Each `set_*()` call returns a **new** modified spec, leaving the original unchanged. This makes it safe to create multiple variants from the same base.
:::

## Conditional Styling with dplyr

A powerful pattern is computing style columns with dplyr before plotting:

```{r}
analysis_data <- data.frame(
  study = c("EMPA-REG", "CANVAS", "DECLARE", "DAPA-HF"),
  hr = c(0.62, 0.86, 0.93, 0.74),
  lower = c(0.49, 0.75, 0.84, 0.65),
  upper = c(0.77, 0.97, 1.03, 0.85),
  pval = c(0.0001, 0.02, 0.17, 0.0001)
)

styled_analysis <- analysis_data |>
  mutate(
    # Significance styling
    is_sig = pval < 0.05,
    sig_color = ifelse(is_sig, "#16a34a", "#94a3b8"),

    # Effect direction
    effect_dir = case_when(
      upper < 1 ~ "benefit",
      lower > 1 ~ "harm",
      TRUE ~ "neutral"
    )
  )

web_spec(styled_analysis,
  point = "hr", lower = "lower", upper = "upper", label = "study",
  columns = list(col_pvalue("pval")),
  scale = "log", null_value = 1
) |>
  set_marker_style(color = "sig_color") |>
  set_row_style(bold = "is_sig") |>
  forest_plot(theme = "modern")
```

::: {.callout-tip}
## Style Column Naming Convention

Use consistent suffixes for style columns:

- `_bold` for bold flags
- `_color` for text colors
- `_bg` for backgrounds
- `_badge` for badge text

This makes it clear which columns are data vs styling.
:::

## Reusable Pipelines

Create reusable styling functions:

```{r}
#| eval: false
# Define a standard styling pipeline
apply_significance_style <- function(spec) {
  spec |>
    set_marker_style(color = "sig_color") |>
    set_row_style(bold = "is_sig") |>
    set_column_style("hr", color = "sig_color")
}

# Use it on different datasets
web_spec(dataset1, ...) |> apply_significance_style() |> forest_plot()
web_spec(dataset2, ...) |> apply_significance_style() |> forest_plot()
```

## Post-Render Modifications

You can modify plots after rendering:

```{r}
# Create a customized theme first
custom_theme <- web_theme_lancet() |>
  set_axis(gridlines = TRUE) |>
  set_spacing(row_height = 32)

# Then apply it to the plot
forest_plot(analysis_data[1:3, ],
  point = "hr", lower = "lower", upper = "upper", label = "study",
  scale = "log", null_value = 1
) |>
  set_theme(custom_theme)
```

::: {.callout-warning}
## Widget Modifications Are Limited
After `forest_plot()`, you can only modify **theme properties** (colors, spacing, axis). Row and marker styling must be set on the WebSpec before rendering.
:::

## Function Reference

| Function | Works On | Purpose |
|----------|----------|---------|
| `set_row_style()` | WebSpec, widget | Row-level styling |
| `set_marker_style()` | WebSpec, widget | Interval marker styling |
| `set_column_style()` | WebSpec | Per-cell column styling |
| `set_theme()` | Both | Apply theme by name/object |
| `set_colors()` | Both | Modify color palette |
| `set_typography()` | Both | Modify fonts |
| `set_spacing()` | Both | Modify spacing |
| `set_shapes()` | Both | Modify shapes |
| `set_axis()` | Both | Modify axis settings |
| `set_layout()` | Both | Modify layout |
| `set_group_headers()` | Both | Modify group header hierarchy |
| `set_marker_colors()` | Both | Set multi-effect color palette |
| `set_marker_shapes()` | Both | Set multi-effect shape palette |

See [web_spec Reference](../reference/web_spec.qmd) for complete parameter documentation.
