---
title: "Columns"
---

```{r}
#| include: false
library(webforest)
```

## Overview

Columns display data alongside the forest plot. Each column type has specialized formatting for different kinds of data.

::: {.callout-tip}
## Column Design Philosophy

webforest uses a **declarative column system**:

1. **You specify what** to display (column type + field)
2. **The renderer decides how** (formatting, width, alignment)

This separates data structure from presentation, making it easy to switch themes or export formats while maintaining consistency.
:::

```{r}
demo_data <- data.frame(
  study = c("Alpha", "Beta", "Gamma", "Delta"),
  or = c(1.2, 0.8, 1.5, 0.95),
  lower = c(0.9, 0.5, 1.1, 0.7),
  upper = c(1.6, 1.3, 2.0, 1.3),
  n = c(500, 320, 180, 420),
  weight = c(28, 22, 15, 35),
  pval = c(0.042, 0.23, 0.008, 0.61)
)

forest_plot(demo_data,
  point = "or", lower = "lower", upper = "upper",
  label = "study", null_value = 1,
  columns = list(
    col_numeric("n", header = "N", width = 60),
    col_bar("weight", header = "Weight %", width = 80),
    col_pvalue("pval", header = "P-value", width = 80),
    col_interval(header = "OR (95% CI)", width = 120, position = "right")
  ),
  theme = web_theme_modern()
)
```

## Column Types at a Glance

| Type | Function | Best For |
|------|----------|----------|
| `col_text()` | Text values | Study names, categories |
| `col_numeric()` | Formatted numbers | Sample sizes, counts, means |
| `col_interval()` | Point (CI) format | Effect size display |
| `col_bar()` | Horizontal bar | Weights, percentages |
| `col_pvalue()` | P-value formatting | Significance with stars |
| `col_n()` | Sample size | Participant counts with K/M abbreviation |
| `col_percent()` | Percentages | Rates, proportions |
| `col_events()` | Events/N format | Clinical event counts |
| `col_sparkline()` | Mini chart | Trends, distributions |
| `col_icon()` | Icons/emoji | Status indicators |
| `col_badge()` | Colored badges | Status labels |
| `col_stars()` | Star ratings | Quality scores |
| `col_img()` | Inline images | Logos, flags |
| `col_reference()` | Truncated links | DOIs, citations |
| `col_range()` | Min-max ranges | Age ranges, value bounds |
| `col_group()` | Group header | Organize related columns |

## Column Positioning

Columns can appear on the left or right side of the forest plot:

```r
columns = list(
  col_numeric("n", "N", position = "left"),       # Left of forest
  col_interval("OR (95% CI)", position = "right") # Right of forest
)
```

::: {.callout-note}
## Default Position

Most column types default to `position = "right"`. The convention is:

- **Left**: Study metadata (sample size, events, weights)
- **Right**: Results and effect estimates (intervals, p-values)
:::

## Core Column Types

### Text Columns

Display text values from any column:

```r
col_text(field = "category", header = "Category", width = 100)
```

### Numeric Columns

Format numbers with flexible precision control:

```r
# Fixed decimal places (default)
col_numeric("value", decimals = 2)

# Significant figures instead
col_numeric("value", digits = 3)

# Abbreviate large numbers: 1,234,567 → "1.2M"
col_numeric("population", abbreviate = TRUE)
```

::: {.callout-tip}
## Decimals vs Digits

- `decimals`: Fixed decimal places (e.g., `decimals = 2` → "1.23")
- `digits`: Significant figures (e.g., `digits = 3` → "1.23", "12.3", "123")

Use `digits` for values spanning multiple orders of magnitude.
:::

### Interval Columns

Show the point estimate and confidence interval in formatted text:

```r
col_interval(header = "OR (95% CI)", width = 120)
```

This automatically formats as `"0.85 (0.70, 1.03)"` using the `point`, `lower`, and `upper` values from each row.

**Advanced options**:

```r
# Custom formatting
col_interval("HR (95% CI)", decimals = 1, sep = ", ")

# Override with different columns
col_interval("Per-Protocol", point = "pp_hr", lower = "pp_lower", upper = "pp_upper")

# Hide imprecise estimates (CI ratio > 10)
col_interval(imprecise_threshold = 10)
```

## Visualization Columns

### Bar Columns

Display horizontal bars for weights or percentages:

```r
col_bar(field = "weight", header = "Weight %", width = 100)
col_bar(field = "weight", color = "#2563eb")  # Custom color
```

### P-value Columns

Format p-values with smart notation and optional significance stars:

```r
col_pvalue(field = "pval", header = "P", stars = TRUE)
```

::: {.callout-note}
## Unicode Superscript Notation
Very small p-values use Unicode superscript for readability:

| Value | Display |
|-------|---------|
| 0.042 | 0.042 |
| 0.00012 | 1.2×10⁻⁴ |
| 0.0000003 | 3.0×10⁻⁷ |

This keeps columns compact while preserving precision.
:::

**Customization**:

```r
# More precision
col_pvalue("pval", digits = 3)

# Earlier exponential notation
col_pvalue("pval", exp_threshold = 0.01)

# Show as "<0.0001" for very small values
col_pvalue("pval", abbrev_threshold = 0.0001)

# Custom star thresholds
col_pvalue("pval", stars = TRUE, thresholds = c(0.10, 0.05, 0.01))
```

### Sample Size Columns

Convenience function for participant counts:

```r
col_n("sample_size")  # Display as integer

# Abbreviate large values: 10,500 → "10.5K"
col_n("sample_size", abbreviate = TRUE)
```

### Percentage Columns

Display proportions as percentages:

```r
# Proportion 0-1 → percentage: 0.25 → "25.0%"
col_percent("rate")

# Already a percentage (0-100)
col_percent("pct", multiply = FALSE)
```

### Events Columns

Show clinical events in "events/N" format:

```r
# Basic: "45/120"
col_events("events", "n")

# With percentage: "45/120 (37.5%)"
col_events("events", "n", show_pct = TRUE)
```

### Sparkline Columns

Display mini charts for trends or distributions:

```r
col_sparkline(field = "trend_data", header = "Trend", width = 80)
col_sparkline(field = "dist", type = "bar", color = "#22c55e")
```

Sparkline types: `"line"` (default), `"area"`, `"bar"`.

::: {.callout-warning}
## List-Columns Required
The sparkline field must contain list-columns with numeric vectors. Create these with `mutate(trend = list(c(1, 2, 3)))` or `nest()`.
:::

## Semantic Columns

### Icon Columns

Display icons or emoji based on data values:

```r
col_icon(field = "status_emoji", header = "Status")

# With value-to-icon mapping
col_icon(field = "status",
  mapping = list(yes = "✓", no = "✗", pending = "⏳")
)
```

### Badge Columns

Display colored status badges:

```r
col_badge(field = "status", header = "Status",
  variants = list(
    published = "success",
    draft = "warning",
    rejected = "error"
  )
)
```

Available variants: `"success"`, `"warning"`, `"error"`, `"info"`, `"muted"`, `"default"`.

### Star Rating Columns

Display 1-5 star ratings:

```r
col_stars(field = "quality", header = "Quality")
col_stars(field = "rating", max_stars = 5, half_stars = TRUE)
```

## Metadata Columns

### Image Columns

Display inline images from URLs:

```r
col_img(field = "logo_url", header = "Logo", shape = "circle")
```

Shapes: `"square"`, `"circle"`, `"rounded"`.

### Reference Columns

Display truncated text with optional links:

```r
col_reference(field = "doi", header = "DOI")
col_reference(field = "pmid", href_field = "pubmed_url", icon = TRUE)
```

### Range Columns

Display min-max ranges from two fields:

```r
col_range(min_field = "age_min", max_field = "age_max",
  header = "Age Range", separator = " – ")
```

## Column Groups

Group related columns under a shared header:

```{r}
set.seed(321)
outcomes_data <- data.frame(
  study = c("PARADIGM-HF", "DAPA-HF", "EMPEROR-Reduced"),
  primary_hr = c(0.80, 0.74, 0.75),
  primary_lower = c(0.73, 0.65, 0.65),
  primary_upper = c(0.87, 0.85, 0.86),
  primary_p = c(0.001, 0.001, 0.001),
  cvdeath_hr = c(0.80, 0.82, 0.92),
  cvdeath_p = c(0.001, 0.029, 0.382)
)

forest_plot(outcomes_data,
  point = "primary_hr", lower = "primary_lower", upper = "primary_upper",
  label = "study", null_value = 1, scale = "log",
  columns = list(
    col_group("Primary Endpoint",
      col_interval("HR (95% CI)"),
      col_pvalue("primary_p", "P"),
      position = "right"
    ),
    col_group("CV Death",
      col_numeric("cvdeath_hr", "HR"),
      col_pvalue("cvdeath_p", "P"),
      position = "right"
    )
  ),
  theme = web_theme_modern()
)
```

::: {.callout-tip}
## Column Group Pattern

Use column groups when you have:

- Multiple outcomes (primary, secondary)
- Multiple time points (30-day, 1-year)
- Multiple analysis types (ITT, per-protocol)

The group header provides context while keeping the table compact.
:::

## Column Width

```r
col_numeric("n", "N", width = 60)      # Narrow
col_text("notes", "Notes", width = 200) # Wide
col_interval()                          # Auto (uses content width)
```

::: {.callout-note}
## Auto-Width Behavior

When `width = NULL` (default), columns auto-size based on:

1. Header text width
2. Maximum cell content width
3. Column type minimums (e.g., bars need space)
4. Column group header width (expands children if needed)
:::

## Styling Columns

### Per-Cell Styling

Every `col_*()` function accepts styling parameters:

```r
col_numeric("hr", "HR",
  bold = "is_significant",    # Column with TRUE/FALSE
  color = "direction_color"   # Column with hex colors
)
```

| Parameter | Type | Description |
|-----------|------|-------------|
| `bold` | Column name (logical) | Bold text when TRUE |
| `italic` | Column name (logical) | Italic text when TRUE |
| `color` | Column name (CSS color) | Text color |
| `bg` | Column name (CSS color) | Background color |
| `badge` | Column name (text) | Badge label |
| `icon` | Column name (text) | Emoji/unicode icon |

### Using set_column_style()

For fluent-style workflows:

```{r}
#| eval: false
web_spec(data,
  point = "hr", lower = "lower", upper = "upper",
  label = "study",
  columns = list(col_numeric("hr", "HR"))
) |>
  set_column_style("hr", bold = "is_significant", color = "hr_color") |>
  forest_plot()
```

See [Cell Styling](cell-styling.qmd) for detailed conditional formatting patterns.
