---
title: "Cookbook"
subtitle: "Common tasks and patterns"
---

```{r}
#| include: false
library(webforest)
library(dplyr)
```

Quick recipes for common forest plot tasks. Each recipe is self-contained and can be adapted to your data.

## Add a Summary Row

Display an overall effect estimate as a diamond:

```{r}
meta_data <- data.frame(
  study = c("Smith 2020", "Jones 2021", "Lee 2022", "Overall"),
  hr = c(0.72, 0.85, 0.91, 0.82),
  lower = c(0.55, 0.70, 0.75, 0.70),
  upper = c(0.95, 1.03, 1.10, 0.96),
  .row_type = c("data", "data", "data", "summary"),
  .row_bold = c(FALSE, FALSE, FALSE, TRUE)
)

forest_plot(meta_data,
  point = "hr", lower = "lower", upper = "upper",
  label = "study", null_value = 1, scale = "log",
  theme = web_theme_modern()
)
```

## Customize Colors for JAMA

Adjust the JAMA theme for your journal's requirements:

```{r}
jama_custom <- web_theme_jama() |>
  set_colors(
    primary = "#000000",        # Black for main elements
    interval_line = "#333333",  # Dark gray CI lines
    interval_positive = "#000000",
    interval_negative = "#000000"
  ) |>
  set_typography(
    font_family = "Arial, sans-serif"  # Common journal font
  )

forest_plot(meta_data[1:3, ],
  point = "hr", lower = "lower", upper = "upper",
  label = "study", null_value = 1, scale = "log",
  theme = jama_custom
)
```

## Show Multiple Effects Per Row

Display ITT, Per-Protocol, and As-Treated analyses on the same row:

```{r}
multi_data <- data.frame(
  study = c("Trial A", "Trial B", "Trial C"),
  itt_or = c(0.79, 0.85, 0.72),
  itt_lower = c(0.66, 0.71, 0.58),
  itt_upper = c(0.95, 1.02, 0.89),
  pp_or = c(0.75, 0.82, 0.68),
  pp_lower = c(0.62, 0.68, 0.54),
  pp_upper = c(0.91, 0.99, 0.86)
)

forest_plot(multi_data,
  point = "itt_or", lower = "itt_lower", upper = "itt_upper",
  label = "study", null_value = 1, scale = "log",
  effects = list(
    web_effect("itt_or", "itt_lower", "itt_upper",
               label = "ITT", color = "#2563eb"),
    web_effect("pp_or", "pp_lower", "pp_upper",
               label = "Per-Protocol", color = "#16a34a")
  ),
  theme = web_theme_modern(),
  footnote = "Blue = ITT, Green = Per-Protocol"
)
```

## Export High-Resolution PNG

For journal submission at 300 DPI:

```r
spec <- web_spec(data,
  point = "hr", lower = "lower", upper = "upper",
  label = "study", null_value = 1, scale = "log",
  theme = web_theme_jama()
)

# 800px * 3 = 2400px for ~8 inch width at 300 DPI
save_plot(spec, "figure1.png", width = 800, scale = 3)
```

## Add Significance Stars to P-values

P-values automatically show stars by default:

```{r}
pval_data <- data.frame(
  study = c("Alpha", "Beta", "Gamma", "Delta"),
  or = c(0.72, 0.95, 0.68, 1.02),
  lower = c(0.55, 0.78, 0.52, 0.84),
  upper = c(0.94, 1.16, 0.89, 1.24),
  pval = c(0.008, 0.42, 0.003, 0.78)
)

forest_plot(pval_data,
  point = "or", lower = "lower", upper = "upper",
  label = "study", null_value = 1,
  columns = list(
    col_pvalue("pval", "P-value")
  ),
  theme = web_theme_modern()
)
```

Customize the thresholds:

```r
col_pvalue("pval", "P",
  options = list(
    thresholds = c(0.05, 0.01, 0.001),  # Default
    show_stars = TRUE
  )
)
```

## Create Nested Subgroups

Two-level hierarchy with region and country:

```{r}
nested_data <- data.frame(
  study = c("Site A", "Site B", "Site C", "Site D", "Site E", "Site F"),
  country = c("USA", "USA", "USA", "UK", "UK", "Germany"),
  or = c(0.82, 0.91, 0.78, 0.85, 0.88, 0.79),
  lower = c(0.68, 0.75, 0.62, 0.70, 0.72, 0.64),
  upper = c(0.99, 1.10, 0.98, 1.03, 1.07, 0.98)
)

forest_plot(nested_data,
  point = "or", lower = "lower", upper = "upper",
  label = "study", group = "country",
  null_value = 1, scale = "log",
  theme = web_theme_modern()
)
```

## Add Weight Bars

Show study weights as horizontal bars:

```{r}
weighted_data <- data.frame(
  study = c("Large RCT", "Medium RCT", "Small RCT"),
  or = c(0.85, 0.78, 0.92),
  lower = c(0.75, 0.62, 0.71),
  upper = c(0.96, 0.98, 1.19),
  weight = c(55, 30, 15)
)

forest_plot(weighted_data,
  point = "or", lower = "lower", upper = "upper",
  label = "study", null_value = 1,
  columns = list(
    col_bar("weight", "Weight %", width = 100)
  ),
  theme = web_theme_modern()
)
```

## Format as Mean Difference

Use linear scale for continuous outcomes:

```{r}
md_data <- data.frame(
  study = c("Trial 1", "Trial 2", "Trial 3"),
  md = c(-2.5, -1.8, -3.2),
  lower = c(-4.1, -3.5, -5.0),
  upper = c(-0.9, -0.1, -1.4)
)

forest_plot(md_data,
  point = "md", lower = "lower", upper = "upper",
  label = "study",
  null_value = 0,  # 0 for differences
  scale = "linear",
  axis_label = "Mean Difference (95% CI)",
  theme = web_theme_modern()
)
```

## Create Headers and Sections

Organize a complex meta-analysis with headers:

```{r}
sectioned_data <- data.frame(
  study = c(
    "Primary Outcomes", "  Mortality", "  CV Events", "  Primary Subtotal",
    "Secondary Outcomes", "  Quality of Life", "  Hospitalizations"
  ),
  hr = c(NA, 0.78, 0.85, 0.82, NA, 0.92, 0.88),
  lower = c(NA, 0.65, 0.72, 0.73, NA, 0.80, 0.76),
  upper = c(NA, 0.94, 1.00, 0.92, NA, 1.06, 1.02),
  .row_type = c("header", "data", "data", "summary",
                "header", "data", "data"),
  .row_bold = c(TRUE, FALSE, FALSE, TRUE, TRUE, FALSE, FALSE),
  .row_indent = c(0, 1, 1, 1, 0, 1, 1)
)

forest_plot(sectioned_data,
  point = "hr", lower = "lower", upper = "upper",
  label = "study", null_value = 1, scale = "log",
  columns = list(col_interval("HR (95% CI)")),
  theme = web_theme_modern()
)
```

## Highlight Specific Studies

Use badges and colors to draw attention:

```{r}
highlight_data <- data.frame(
  study = c("Landmark Trial", "Study B", "Study C", "Study D"),
  or = c(0.72, 0.85, 0.91, 0.88),
  lower = c(0.60, 0.70, 0.75, 0.72),
  upper = c(0.86, 1.03, 1.10, 1.07),
  .row_bold = c(TRUE, FALSE, FALSE, FALSE),
  .row_badge = c("Key", NA, NA, NA),
  .row_color = c("#2563eb", NA, NA, NA)
)

forest_plot(highlight_data,
  point = "or", lower = "lower", upper = "upper",
  label = "study", null_value = 1,
  theme = web_theme_modern()
)
```

## Use Dark Theme for Presentations

```{r}
forest_plot(meta_data[1:3, ],
  point = "hr", lower = "lower", upper = "upper",
  label = "study", null_value = 1, scale = "log",
  theme = web_theme_dark(),
  title = "Treatment Effect",
  subtitle = "For presentation slides"
)
```
